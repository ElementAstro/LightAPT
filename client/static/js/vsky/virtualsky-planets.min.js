/*!
	Virtual Sky add on to display planets without 
	needing a file regularly updated from JPL Horizons
	Written by Stuart Lowe (http://www.strudel.org.uk/)
 */
!function(S){function init(){this.bind("loadedPlanets",(function(d){this.jd=this.times.JD;var p=new Planets,days=365.25;this.planets=p.build(Math.floor(this.jd)-91.3125,456.5625);var loadtime=this.times.JD,i=this.calendarevents.length;this.calendarevents.push((function(){Math.abs(loadtime-this.times.JD)>=91.3125&&(this.calendarevents.splice(i,1),this.trigger("loadedPlanets"),this.draw())})),this.draw()}))}function Planets(){return this.planets=[{name:"Me",radius:2439.7,interval:.5,colour:"rgb(170,150,170)",magnitude:function(d){return 5*log10(d.r*d.R)-.36+.027*d.FV+22e-14*Math.pow(d.FV,6)},elements:[{jd:2456280.5,i:7.0053,o:48.485,p:77.658,a:.3871,n:4.09232,e:.205636,L:191.7001},{jd:2456360.5,i:7.0052,o:48.487,p:77.663,a:.387098,n:4.09235,e:.205646,L:159.0899},{jd:2456440.5,i:7.0052,o:48.49,p:77.665,a:.387097,n:4.09236,e:.20565,L:126.4812},{jd:2456520.5,i:7.0052,o:48.493,p:77.669,a:.387098,n:4.09235,e:.205645,L:93.8725},{jd:2456600.5,i:7.0052,o:48.495,p:77.672,a:.387099,n:4.09234,e:.205635,L:61.2628},{jd:2456680.5,i:7.0052,o:48.498,p:77.677,a:.387098,n:4.09234,e:.205633,L:28.6524}]},{name:"V",radius:6051.9,interval:1,colour:"rgb(245,222,179)",magnitude:function(d){return 5*log10(d.a*d.R)-4.34+.013*d.FV+42e-8*Math.pow(d.FV,3)},elements:[{jd:2456280.5,i:3.3949,o:76.797,p:132,a:.723328,n:1.60214,e:.006777,L:209.0515},{jd:2456360.5,i:3.3949,o:76.799,p:132.07,a:.723327,n:1.60215,e:.006787,L:337.2248},{jd:2456440.5,i:3.3949,o:76.802,p:131.97,a:.723333,n:1.60213,e:.00678,L:105.398},{jd:2456520.5,i:3.3949,o:76.804,p:131.99,a:.723327,n:1.60215,e:.006769,L:233.5729},{jd:2456600.5,i:3.3949,o:76.807,p:132.03,a:.723326,n:1.60215,e:.006775,L:1.7475},{jd:2456680.5,i:3.3948,o:76.808,p:131.63,a:.723345,n:1.60209,e:.00677,L:129.9169}]},{name:"E",elements:[{jd:2450680.5,i:41e-5,o:349.2,p:102.8517,a:1.00002,n:.9855796,e:.0166967,L:328.40353},{jd:2456320.5,i:0,o:349.2,p:103.005,a:.999986,n:.985631,e:.016682,L:127.4201},{jd:2456400.5,i:0,o:349.2,p:103.022,a:.999987,n:.98563,e:.016677,L:206.274},{jd:2456480.5,i:0,o:349.2,p:103.119,a:1.000005,n:.985603,e:.016675,L:285.1238},{jd:2456560.5,i:0,o:349.2,p:103.161,a:.999995,n:.985618,e:.016682,L:3.9752},{jd:2456680.5,i:0,o:349.2,p:103.166,a:1.000005,n:.985603,e:.016693,L:122.2544}]},{name:"Ma",radius:3386,interval:1,colour:"rgb(255,50,50)",magnitude:function(d){return 5*log10(d.r*d.R)-1.51+.016*d.FV},elements:[{jd:2450680.5,i:1.84992,o:49.5664,p:336.0882,a:1.5236365,n:.5240613,e:.0934231,L:262.42784},{jd:2456320.5,i:1.8497,o:49.664,p:336.249,a:1.523605,n:.524079,e:.093274,L:338.1493},{jd:2456400.5,i:1.8497,o:49.666,p:336.268,a:1.523627,n:.524068,e:.093276,L:20.0806},{jd:2456480.5,i:1.8496,o:49.668,p:336.306,a:1.523731,n:.524014,e:.093316,L:62.0048},{jd:2456560.5,i:1.8495,o:49.666,p:336.329,a:1.523748,n:.524005,e:.093385,L:103.9196},{jd:2456680.5,i:1.8495,o:49.665,p:336.33,a:1.523631,n:.524066,e:.093482,L:166.8051}]},{name:"J",radius:69173,interval:10,colour:"rgb(255,150,150)",magnitude:function(d){return 5*log10(d.r*d.R)-9.25+.014*d.FV},elements:[{jd:2456280.5,i:1.3033,o:100.624,p:14.604,a:5.20269,n:.083094,e:.048895,L:68.0222},{jd:2456360.5,i:1.3033,o:100.625,p:14.588,a:5.20262,n:.083095,e:.048895,L:74.6719},{jd:2456440.5,i:1.3033,o:100.627,p:14.586,a:5.20259,n:.083096,e:.048892,L:81.3228},{jd:2456520.5,i:1.3033,o:100.629,p:14.556,a:5.20245,n:.083099,e:.048892,L:87.9728},{jd:2456600.5,i:1.3033,o:100.631,p:14.576,a:5.20254,n:.083097,e:.048907,L:94.6223},{jd:2456680.5,i:1.3033,o:100.633,p:14.592,a:5.20259,n:.083096,e:.048891,L:101.2751},{jd:2456681,i:1.3033,o:100.633,p:14.592,a:5.20259,n:.083096,e:.048891,L:100.29282654}]},{name:"S",radius:57316,interval:10,colour:"rgb(200,150,150)",magnitude:function(d){for(var slon=Math.atan2(d.y,d.x),slat=Math.atan2(d.z,Math.sqrt(d.x*d.x+d.y*d.y));slon<0;)slon+=2*Math.PI;for(;slon>=360;)slon-=2*Math.PI;var ir=28.06*d.d2r,Nr=d.d2r*(169.51+382e-7*(d.jd-2451543.5)),B=Math.asin(Math.sin(slat)*Math.cos(ir)-Math.cos(slat)*Math.sin(ir)*Math.sin(slon-Nr));return 5*log10(d.r*d.R)-9+.044*d.FV+(-2.6*Math.sin(Math.abs(B))+1.2*Math.pow(Math.sin(B),2))},elements:[{jd:2456280.5,i:2.4869,o:113.732,p:90.734,a:9.51836,n:.033583,e:.055789,L:208.6057},{jd:2456360.5,i:2.4869,o:113.732,p:90.979,a:9.52024,n:.033574,e:.055794,L:211.2797},{jd:2456440.5,i:2.4869,o:113.732,p:91.245,a:9.52234,n:.033562,e:.055779,L:213.9525},{jd:2456520.5,i:2.4869,o:113.732,p:91.5,a:9.5245,n:.033551,e:.055724,L:216.6279},{jd:2456600.5,i:2.487,o:113.732,p:91.727,a:9.5263,n:.033541,e:.055691,L:219.3014},{jd:2456680.5,i:2.487,o:113.733,p:92.021,a:9.52885,n:.033528,e:.0556,L:221.973}]},{name:"U",radius:25266,interval:20,colour:"rgb(130,150,255)",magnitude:function(d){return 5*log10(d.r*d.R)-7.15+.001*d.FV},elements:[{jd:2456280.5,i:.7726,o:74.004,p:169.227,a:19.2099,n:.011713,e:.046728,L:9.14},{jd:2456360.5,i:.7727,o:73.997,p:169.314,a:19.203,n:.01172,e:.047102,L:10.0873},{jd:2456440.5,i:.7728,o:73.989,p:169.434,a:19.1953,n:.011727,e:.047509,L:11.034},{jd:2456520.5,i:.7728,o:73.989,p:169.602,a:19.1882,n:.011733,e:.047874,L:11.9756},{jd:2456600.5,i:.7728,o:73.985,p:169.74,a:19.1816,n:.011739,e:.048215,L:12.92},{jd:2456680.5,i:.7728,o:73.983,p:169.962,a:19.1729,n:.011747,e:.04865,L:13.8617}]},{name:"N",radius:24553,interval:20,colour:"rgb(100,100,255)",magnitude:function(d){return 5*log10(d.r*d.R)-6.9+.001*d.FV},elements:[{jd:2456280.5,i:1.7686,o:131.93,p:53.89,a:30.0401,n:.00599,e:.010281,L:333.6121},{jd:2456360.5,i:1.7688,o:131.935,p:56.47,a:30.0259,n:.005994,e:.010138,L:334.0856},{jd:2456440.5,i:1.769,o:131.94,p:59.24,a:30.0108,n:.005999,e:.009985,L:334.5566},{jd:2456520.5,i:1.7692,o:131.946,p:61.52,a:29.9987,n:.006002,e:.009816,L:335.0233},{jd:2456600.5,i:1.7694,o:131.951,p:63.84,a:29.9867,n:.006006,e:.00969,L:335.4937},{jd:2456680.5,i:1.7697,o:131.957,p:66.66,a:29.9725,n:.00601,e:.009508,L:335.9564}]}],this.d2r=Math.PI/180,this.r2d=180/Math.PI,this.AUinkm=149597870.7,this}function clone(d){return JSON.parse(JSON.stringify(d))}function log10(x){return Math.LOG10E*Math.log(x)}Planets.prototype.build=function(jd,days){var arr=new Array(this.planets.length-1),b=0;days||(days=365.25);for(var a=0;a<this.planets.length;a++)this.planets[a].colour&&(arr[b++]=this.buildPlanet(a,jd,days));return arr},Planets.prototype.buildPlanet=function(planet,jd,days){var p,coord,interval,n,jdcurr;if("number"==typeof planet)p=planet;else{for(var match=-1,a=0;a<this.planets.length;a++)this.planets[a].name==planet&&(match=a);if(match<0)return this;if(2==match)return this;p=match}interval="number"==typeof this.planets[p].interval?this.planets[p].interval:1,n=Math.floor(days/interval);var arr=new Array(3);arr[0]=this.planets[p].name,arr[1]=this.planets[p].colour,arr[2]=new Array(4*n),jdcurr=jd;for(var i=0;i<n;i++)jdcurr+=interval,coord=this.getEphem(p,jdcurr),arr[2][4*i+0]=jdcurr,arr[2][4*i+1]=coord[0],arr[2][4*i+2]=coord[1],arr[2][4*i+3]=coord[2];return arr},Planets.prototype.getEphem=function(planet,day){var i,v,e,x,y,z,ec,q,ra,dc,R,mag,FV,phase;if("number"==typeof planet)i=planet;else{for(var match=-1,a=0;a<this.planets.length;a++)this.planets[a].name==planet&&(match=a);if(match<0)return this;if(2==match)return this;i=match}return v=this.getHeliocentric(this.planets[i],day),e=this.getHeliocentric(this.planets[2],day),x=v.xyz[0]-e.xyz[0],y=v.xyz[1]-e.xyz[1],z=v.xyz[2]-e.xyz[2],ec=23.439292*this.d2r,q=[x,y*Math.cos(ec)-z*Math.sin(ec),y*Math.sin(ec)+z*Math.cos(ec)],ra=Math.atan(q[1]/q[0])*this.r2d,q[0]<0&&(ra+=180),q[0]>=0&&q[1]<0&&(ra+=360),dc=Math.atan(q[2]/Math.sqrt(q[0]*q[0]+q[1]*q[1]))*this.r2d,R=Math.sqrt(q[0]*q[0]+q[1]*q[1]+q[2]*q[2]),mag=1,FV=Math.acos((v.r*v.r+R*R-e.r*e.r)/(2*v.r*R)),phase=(1+Math.cos(FV))/2,[ra,dc,mag=this.planets[i].magnitude({a:v.r,r:v.r,R:R,FV:FV*this.r2d,x:x,y:y,z:z,jd:day,d2r:this.d2r})]},Planets.prototype.getHeliocentric=function(planet,jd,i){var min=1e10,mn,p,d,M,v,r;if(!i)for(var j=0;j<planet.elements.length;j++)(mn=Math.abs(planet.elements[j].jd-jd))<min&&(i=j,min=mn);return d=jd-(p=clone(planet.elements[i])).jd,M=this.meanAnomaly(p.n,d,p.L,p.p),v=this.trueAnomaly(M*this.d2r,p.e,10),r=p.a*(1-Math.pow(p.e,2))/(1+p.e*Math.cos(v*this.d2r)),{xyz:this.heliocentric(v*this.d2r,r,p.p*this.d2r,p.o*this.d2r,p.i*this.d2r),M:M,v:v,r:r,i:i,d:d,elements:p}},Planets.prototype.meanAnomaly=function(d,n,L,p){for(var M=n*d+L-p;M<0;)M+=360;for(;M>=360;)M-=360;return M},Planets.prototype.heliocentric=function(v,r,p,o,i){var vpo=v+p-o,svpo=Math.sin(vpo),cvpo=Math.cos(vpo),co=Math.cos(o),so=Math.sin(o),ci=Math.cos(i),si;return[r*(co*cvpo-so*svpo*ci),r*(so*cvpo+co*svpo*ci),r*(svpo*Math.sin(i))]},Planets.prototype.trueAnomaly=function(m,ecc,eps){var v,e=m;if("number"==typeof eps){for(var delta=.05;Math.abs(delta)>=Math.pow(10,-eps);)e-=(delta=e-ecc*Math.sin(e)-m)/(1-ecc*Math.cos(e));(v=2*Math.atan(Math.pow((1+ecc)/(1-ecc),.5)*Math.tan(.5*e)))<0&&(v+=2*Math.PI)}else v=m+((2*ecc-Math.pow(ecc,3)/4)*Math.sin(m)+1.25*Math.pow(ecc,2)*Math.sin(2*m)+13/12*Math.pow(ecc,3)*Math.sin(3*m));return v*this.r2d};for(var match=!1,i=0;i<S.virtualsky.plugins.length;i++)"planets"==S.virtualsky.plugins[i].name&&(match=!0);match||S.virtualsky.plugins.push({init:init,name:"planets",version:"1.0"})}(S);